<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>ìš´ì •í˜¸ìˆ˜ í­ìš° AR ë¯¸ì…˜</title>

  <style>
    :root{
      --bg:#0b1020; --panel:rgba(0,0,0,.65); --text:#f5f7ff;
      --red:#ff3b30; --blue:#2f7dff; --ok:#7CFF9A; --bad:#FF7C7C;
    }
    *{box-sizing:border-box}
    body{
      margin:0; overflow:hidden; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    }

    .stage{position:fixed; inset:0; display:none; align-items:center; justify-content:center}
    .stage.active{display:flex}

    .panel{
      width:min(680px,92vw);
      padding:18px 16px;
      border-radius:18px;
      background:var(--panel);
      backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,.12);
    }

    .warning{border:1px solid rgba(255,59,48,.35)}
    .blink-dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--red);
      box-shadow:0 0 18px rgba(255,59,48,.9);
      animation:blink 1s infinite;
      margin-bottom:10px;
    }
    @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:.15}}
    .warning-title{font-weight:950;letter-spacing:.08em;color:var(--red);font-size:18px}
    .warning-msg{font-size:20px;font-weight:950;margin-top:6px}
    .sub{opacity:.9;margin:10px 0 14px 0;line-height:1.45}

    button{
      width:100%;
      border:0;
      border-radius:999px;
      padding:14px 16px;
      font-size:16px;
      font-weight:900;
      margin-top:10px;
      cursor:pointer;
      touch-action:manipulation;
    }
    .primary{background:rgba(47,125,255,.95);color:#fff}
    .ghost{background:rgba(255,255,255,.10);color:#fff}
    button:disabled{opacity:.45;cursor:not-allowed}

    .footer-hint{
      position:fixed; bottom:14px; left:0; right:0;
      text-align:center; font-size:13px; opacity:.75;
      padding:0 12px;
    }

    /* ì¹´ë©”ë¼ + ì˜¤ë²„ë ˆì´ */
    #cam{
      position:fixed; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      background:#000;
    }
    #rain{
      position:fixed; inset:0;
      width:100%; height:100%;
      pointer-events:none;
    }

    /* (1) ìˆ˜ìœ„ ìƒìŠ¹ í‘œí˜„ ê°•í™”: ë” ì§„í•œ íŒŒë€ ë¬¼ + í™”ë©´ ì ˆë°˜ ì´ìƒê¹Œì§€ */
    #water{
      position:fixed; left:0; right:0; bottom:0;
      height:0%;
      pointer-events:none;

      /* ì§„í•˜ê³  ì„ ëª…í•œ ë¬¼ ë ˆì´ì–´ */
      background:
        radial-gradient(1200px 260px at 50% 0%, rgba(255,255,255,.22), rgba(255,255,255,0) 65%),
        linear-gradient(to top,
          rgba(10,60,255,.92),
          rgba(0,155,255,.78) 55%,
          rgba(0,170,255,.50) 78%,
          rgba(0,170,255,.22) 92%,
          rgba(0,170,255,0) 100%
        );

      /* ë¬¼ ëŠë‚Œì„ ë” ê°•í•˜ê²Œ */
      filter: saturate(1.2) contrast(1.1);
      box-shadow: 0 -18px 50px rgba(0,140,255,.35) inset;

      transition:height 6s linear;
    }

    /* ë¬¼ í‘œë©´(ìƒë‹¨ ê°€ì¥ìë¦¬) ë¼ì¸ + ì‚´ì§ ì¶œë ì„ */
    #water::before{
      content:"";
      position:absolute; left:-10%; right:-10%; top:-18px;
      height:28px;
      background: linear-gradient(to bottom, rgba(255,255,255,.40), rgba(255,255,255,0));
      opacity:.85;
      filter: blur(1px);
      animation: surface 1.2s ease-in-out infinite;
    }
    @keyframes surface{
      0%,100%{transform:translateX(0)}
      50%{transform:translateX(18px)}
    }

    /* (2) ê²½ê³  ë¬¸êµ¬ëŠ” ë‚˜ì¤‘ì— ë“±ì¥ + 3ë°° ì´ìƒ í¬ê²Œ + ë¹¨ê°„ìƒ‰ */
    #waterText{
      position:absolute;
      left:16px;
      right:16px;
      top:22px;

      font-size:48px;           /* í¬ê²Œ */
      font-weight:950;
      color:var(--red);         /* ë¹¨ê°„ìƒ‰ */
      letter-spacing:-0.02em;
      line-height:1.1;

      text-shadow:
        0 2px 0 rgba(0,0,0,.55),
        0 10px 24px rgba(0,0,0,.55);

      opacity:0;
      transform: translateY(-10px) scale(0.98);
      transition: opacity 240ms ease, transform 240ms ease;
      pointer-events:none;
    }
    #waterText.show{
      opacity:1;
      transform: translateY(0) scale(1);
    }

    .hud{
      position:fixed; top:12px; left:12px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px 12px;
      backdrop-filter: blur(8px);
    }
    .hud-title{font-weight:950}
    .hud-sub{opacity:.85;margin-top:2px}

    /* ëª¨ë‹¬ */
    .modal{
      position:fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
    }
    .modal.open{display:flex}
    .modal-card{
      width:min(720px,92vw);
      border-radius:18px;
      padding:16px 16px 14px;
      background:rgba(15,18,30,.92);
      border:1px solid rgba(255,255,255,.12);
    }
    .modal-title{font-size:18px;font-weight:950;margin:6px 0 10px}
    .modal-body{opacity:.95;line-height:1.55}
    .row{display:flex;gap:10px;margin:8px 0}
    .k{min-width:120px;opacity:.8}
    .v{flex:1}
    .shieldBig{font-size:46px; filter:drop-shadow(0 6px 18px rgba(47,125,255,.25));}

    /* í€´ì¦ˆ */
    .pill{
      display:inline-block;font-size:13px;opacity:.9;
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      margin:2px 0 10px;
    }
    .q-title{font-weight:950;margin-bottom:10px}
    .opt{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 12px; border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      margin:8px 0;
    }
    .opt input{margin-top:2px}
    .feedback{margin-top:10px;min-height:22px;font-weight:950}
    .feedback.ok{color:var(--ok)}
    .feedback.bad{color:var(--bad)}

    /* ë³´ìƒ/ì™„ë£Œ */
    .reward-card{text-align:center}
    .rewardShield{font-size:74px;margin:8px 0 6px;animation:pop 650ms ease-out both}
    @keyframes pop{0%{transform:scale(.2);opacity:0}70%{transform:scale(1.18);opacity:1}100%{transform:scale(1);opacity:1}}

    /* ì˜¤ë¥˜ ì•ˆë‚´ ë°” */
    #errorBar{
      position:fixed; left:10px; right:10px; bottom:10px;
      display:none;
      background:rgba(255,59,48,.20);
      border:1px solid rgba(255,59,48,.45);
      border-radius:14px;
      padding:12px 12px;
      line-height:1.45;
      backdrop-filter: blur(8px);
    }
    #errorBar.show{display:block}
    #errorTitle{font-weight:950}
    #errorMsg{opacity:.95;margin-top:4px}
  </style>
</head>

<body>
  <!-- 1ë‹¨ê³„ -->
  <section id="stage1" class="stage active">
    <div class="panel warning">
      <div class="blink-dot"></div>
      <div class="warning-title">WARNING</div>
      <div class="warning-msg">ì§‘ì¤‘í˜¸ìš° ì‹œë®¬ë ˆì´ì…˜ ê°€ë™</div>
      <div class="sub">
        ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¹´ë©”ë¼ í™”ë©´ ìœ„ì— <b>í­ìš° + ê°•í•œ ìˆ˜ìœ„ ìƒìŠ¹</b>ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
      </div>

      <button id="startBtn" class="primary" type="button">ìŠ¤ìºë„ˆ ì‹œì‘ (ì¹´ë©”ë¼ í—ˆìš©)</button>
      <button id="retryBtn" class="ghost" type="button">ë¬¸ì œê°€ ìˆìœ¼ë©´ ë‹¤ì‹œ ì‹œë„</button>
    </div>

    <div class="footer-hint">
      ê°€ëŠ¥í•˜ë©´ Safari/Chromeì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”. (ì¸ì•± ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ê°€ ë§‰í ìˆ˜ ìˆìŠµë‹ˆë‹¤)
    </div>
  </section>

  <!-- 2ë‹¨ê³„ -->
  <section id="stage2" class="stage">
    <video id="cam" playsinline muted autoplay></video>
    <canvas id="rain"></canvas>

    <div id="water">
      <div id="waterText">ìˆ˜ìœ„ ìƒìŠ¹â€¦ ì‚°ì±…ë¡œ ì¹¨ìˆ˜ ìœ„í—˜!</div>
    </div>

    <div class="hud">
      <div class="hud-title">[ì‹œë®¬ë ˆì´ì…˜] ì‹œê°„ë‹¹ 100mm í­ìš°</div>
      <div id="timer" class="hud-sub">00:00</div>
    </div>
  </section>

  <!-- 3ë‹¨ê³„: ì‹œìŠ¤í…œ ì§„ë‹¨ (í€´ì¦ˆí•˜ê¸° ë²„íŠ¼ ì—†ìŒ) -->
  <div id="diagnosis" class="modal">
    <div class="modal-card">
      <div class="shieldBig">ğŸ›¡ï¸</div>
      <div class="modal-title">[ì‹œìŠ¤í…œ ì§„ë‹¨ ê²°ê³¼]</div>
      <div class="modal-body">
        <div class="row"><span class="k">ìƒí™©</span><span class="v">ì‹œê°„ë‹¹ 100mm ê¸°ë¡ì  í­ìš° ë°œìƒ!</span></div>
        <div class="row"><span class="k">ìš´ì •í˜¸ìˆ˜ ìƒíƒœ</span><span class="v">ë¹—ë¬¼ <b id="retentionText">ì•½ 32ë§Œ í†¤</b> ì €ë¥˜ ì„±ê³µ! (ìŠ¤í€ì§€ ëª¨ë“œ ì‘ë™ ì¤‘)</span></div>
        <div class="row"><span class="k">ê²°ê³¼</span><span class="v">ì£¼ë³€ ì¹¨ìˆ˜ ë°©ì–´ ì™„ë£Œ. <b>ì•ˆì „í•©ë‹ˆë‹¤.</b></span></div>
      </div>

      <!-- (3) íŒì—… ì•„ë˜ ë²„íŠ¼: ë‹¤ìŒ í™”ë©´ìœ¼ë¡œ -->
      <button id="toQuizBtn" class="primary" type="button">ë‹¤ìŒ í™”ë©´ìœ¼ë¡œ</button>
      <button id="closeDiagnosisBtn" class="ghost" type="button">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- í€´ì¦ˆ(2ë¬¸í•­ ìˆœì„œëŒ€ë¡œ) -->
  <div id="quiz" class="modal">
    <div class="modal-card">
      <div class="modal-title">ê·¸ë¦°ì¸í”„ë¼ í€´ì¦ˆ</div>
      <div id="quizProgress" class="pill">1 / 2</div>

      <form id="quizForm">
        <div class="modal-body">
          <div id="qTitle" class="q-title">ë¬¸ì œ ë¡œë”© ì¤‘â€¦</div>
          <div id="options"></div>
          <div id="quizFeedback" class="feedback"></div>
        </div>

        <button id="submitBtn" class="primary" type="submit">ì œì¶œ</button>
        <button id="nextBtn" class="primary" type="button" style="display:none;">ë‹¤ìŒ ë¬¸ì œ</button>
        <button id="closeQuizBtn" class="ghost" type="button">ë‹«ê¸°</button>
      </form>
    </div>
  </div>

  <!-- ë³´ìƒ -->
  <div id="reward" class="modal">
    <div class="modal-card reward-card">
      <div class="rewardShield">ğŸ›¡ï¸</div>
      <div class="modal-title">ë°©íŒ¨ íšë“!</div>
      <div id="rewardMsg" class="modal-body">
        2ë¬¸í•­ ëª¨ë‘ ì •ë‹µì…ë‹ˆë‹¤. ê·¸ë¦°ì¸í”„ë¼ëŠ” ë¹—ë¬¼ì„ ì²œì²œíˆ ëª¨ìœ¼ê³  ìŠ¤ë©°ë“¤ê²Œ í•©ë‹ˆë‹¤.
      </div>
      <button id="rewardOkBtn" class="primary" type="button">ì™„ë£Œ</button>
    </div>
  </div>

  <!-- ì™„ë£Œ -->
  <section id="stageDone" class="stage">
    <div class="panel">
      <div style="font-weight:950;font-size:20px;">ë¯¸ì…˜ ì™„ë£Œ âœ…</div>
      <div style="opacity:.9;margin-top:8px;line-height:1.55;">
        ë°©íŒ¨ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.<br/>ì´ ì°½(íƒ­)ì„ ë‹«ê³  ë‹¤ìŒ í™œë™ìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”.
      </div>
      <button id="doneBtn" class="primary" type="button">ì¢…ë£Œ ì•ˆë‚´</button>
      <button id="restartBtn" class="ghost" type="button">(êµì‚¬ìš©) ë‹¤ì‹œ ì‹œì‘</button>
    </div>
    <div class="footer-hint">ì›¹í˜ì´ì§€ëŠ” ë³´ì•ˆ ì •ì±…ìƒ ë²„íŠ¼ìœ¼ë¡œ íƒ­ì„ ê°•ì œ ì¢…ë£Œí•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤.</div>
  </section>

  <!-- ì˜¤ë¥˜ ë°” -->
  <div id="errorBar" role="status" aria-live="polite">
    <div id="errorTitle">ì‹¤í–‰ì´ ë§‰í˜”ìŠµë‹ˆë‹¤</div>
    <div id="errorMsg"></div>
  </div>

  <script>
    // ===== ì„¤ì • =====
    const CONFIG = {
      floodSeconds: 6,          // ë¬¼ ì˜¬ë¼ê°€ëŠ” ì‹œê°„(ë¹ ë¥´ê²Œ/ê°•í•˜ê²Œ)
      diagnoseAtSeconds: 9,
      waterTargetHeight: 68,    // (1) í™”ë©´ ì ˆë°˜ ì´ìƒ(%)ê¹Œì§€ ìƒìŠ¹
      waterTextShowDelayMs: 2600 // (2) ë¬¼ì´ ì–´ëŠ ì •ë„ ì˜¤ë¥¸ ë’¤ ë¬¸êµ¬ ë“±ì¥
    };

    // ===== DOM =====
    const stage1 = document.getElementById("stage1");
    const stage2 = document.getElementById("stage2");
    const stageDone = document.getElementById("stageDone");

    const startBtn = document.getElementById("startBtn");
    const retryBtn = document.getElementById("retryBtn");

    const cam = document.getElementById("cam");
    const rainCanvas = document.getElementById("rain");
    const water = document.getElementById("water");
    const waterText = document.getElementById("waterText");
    const timerEl = document.getElementById("timer");

    const diagnosis = document.getElementById("diagnosis");
    const retentionText = document.getElementById("retentionText");
    const toQuizBtn = document.getElementById("toQuizBtn");
    const closeDiagnosisBtn = document.getElementById("closeDiagnosisBtn");

    const quiz = document.getElementById("quiz");
    const quizForm = document.getElementById("quizForm");
    const quizProgress = document.getElementById("quizProgress");
    const qTitle = document.getElementById("qTitle");
    const optionsBox = document.getElementById("options");
    const quizFeedback = document.getElementById("quizFeedback");
    const closeQuizBtn = document.getElementById("closeQuizBtn");
    const submitBtn = document.getElementById("submitBtn");
    const nextBtn = document.getElementById("nextBtn");

    const reward = document.getElementById("reward");
    const rewardOkBtn = document.getElementById("rewardOkBtn");

    const doneBtn = document.getElementById("doneBtn");
    const restartBtn = document.getElementById("restartBtn");

    const errorBar = document.getElementById("errorBar");
    const errorMsg = document.getElementById("errorMsg");

    // ===== ìœ í‹¸ =====
    function showStage(el){
      stage1.classList.remove("active");
      stage2.classList.remove("active");
      stageDone.classList.remove("active");
      el.classList.add("active");
    }
    function showError(text){
      errorMsg.textContent = text;
      errorBar.classList.add("show");
      setTimeout(()=>errorBar.classList.remove("show"), 6500);
    }

    // ===== ì¹´ë©”ë¼ =====
    async function startCamera(){
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        throw new Error("ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
      const stream = await navigator.mediaDevices.getUserMedia({
        video:{facingMode:"environment"},
        audio:false
      });
      cam.srcObject = stream;
      await cam.play();
    }
    function stopCamera(){
      try{
        const s = cam.srcObject;
        if(s && s.getTracks) s.getTracks().forEach(t=>t.stop());
        cam.srcObject = null;
      }catch(e){}
    }

    // ===== íƒ€ì´ë¨¸ =====
    let timerHandle=null;
    function startTimer(){
      const t0=Date.now();
      timerEl.textContent="00:00";
      timerHandle=setInterval(()=>{
        const sec=Math.floor((Date.now()-t0)/1000);
        const mm=String(Math.floor(sec/60)).padStart(2,"0");
        const ss=String(sec%60).padStart(2,"0");
        timerEl.textContent=`${mm}:${ss}`;
      },250);
    }
    function stopTimer(){
      if(timerHandle) clearInterval(timerHandle);
      timerHandle=null;
    }

    // ===== ë¬¼(ê°•í™” + ë¬¸êµ¬ ì§€ì—° ë“±ì¥) =====
    function startWaterRise(){
      // ë¬¸êµ¬ëŠ” ì²˜ìŒì—” ìˆ¨ê¹€
      waterText.classList.remove("show");

      // ë¬¼ ë†’ì´ ë¦¬ì…‹ í›„ ì‹œì‘
      water.style.transition = "none";
      water.style.height = "0%";
      // ë‹¤ìŒ í”„ë ˆì„ì—ì„œ íŠ¸ëœì§€ì…˜ ì ìš© (í™•ì‹¤íˆ ì• ë‹ˆë©”ì´ì…˜ ë‚˜ì˜¤ê²Œ)
      requestAnimationFrame(()=>{
        water.style.transition = `height ${CONFIG.floodSeconds}s linear`;
        water.style.height = `${CONFIG.waterTargetHeight}%`;
      });

      // (2) ë¬¼ì´ ì–´ëŠ ì •ë„ ì˜¤ë¥¸ ë’¤ ë¬¸êµ¬ í‘œì‹œ
      setTimeout(()=>{
        waterText.classList.add("show");
      }, CONFIG.waterTextShowDelayMs);
    }

    function resetWater(){
      water.style.transition="none";
      water.style.height="0%";
      waterText.classList.remove("show");
    }

    // ===== í­ìš°(ê°•í•œ ìº”ë²„ìŠ¤) =====
    let rainRunning=false;
    let rafId=null;

    function startRainStrong(){
      const ctx = rainCanvas.getContext("2d");

      function resize(){
        const dpr = window.devicePixelRatio || 1;
        rainCanvas.width = Math.floor(innerWidth*dpr);
        rainCanvas.height = Math.floor(innerHeight*dpr);
        rainCanvas.style.width = innerWidth+"px";
        rainCanvas.style.height = innerHeight+"px";
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      resize();
      window.addEventListener("resize", resize);

      const drops=[];
      const COUNT = 700;
      for(let i=0;i<COUNT;i++){
        drops.push({
          x: Math.random()*innerWidth,
          y: Math.random()*innerHeight,
          len: 18 + Math.random()*55,
          spd: 28 + Math.random()*55,
          a: 0.55 + Math.random()*0.40,
          w: 1.6 + Math.random()*1.6
        });
      }

      rainRunning=true;
      const loop=()=>{
        if(!rainRunning) return;
        ctx.clearRect(0,0,innerWidth,innerHeight);

        // í­ìš° ì»¤íŠ¼ ëŠë‚Œ ì‚´ì§
        ctx.fillStyle = "rgba(210,230,255,0.05)";
        ctx.fillRect(0,0,innerWidth,innerHeight);

        for(const d of drops){
          ctx.lineWidth = d.w;
          ctx.strokeStyle = `rgba(245,250,255,${d.a})`;
          ctx.beginPath();
          ctx.moveTo(d.x, d.y);
          ctx.lineTo(d.x + 2.2, d.y + d.len);
          ctx.stroke();

          d.y += d.spd;
          d.x += 3.6;
          if(d.y > innerHeight){ d.y = -d.len; d.x = Math.random()*innerWidth; }
          if(d.x > innerWidth) d.x = 0;
        }
        rafId = requestAnimationFrame(loop);
      };
      loop();
    }

    function stopRain(){
      rainRunning=false;
      if(rafId) cancelAnimationFrame(rafId);
      rafId=null;
      const ctx=rainCanvas.getContext("2d");
      ctx.clearRect(0,0,innerWidth,innerHeight);
    }

    // ===== ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ =====
    async function startSimulation(){
      errorBar.classList.remove("show");
      try{
        await startCamera();
      }catch(e){
        showError(
          "ì¹´ë©”ë¼ê°€ ì—´ë¦¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Safari/Chromeì—ì„œ ì—´ê³  ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.\n" +
          "ì˜¤ë¥˜: " + (e.message || e)
        );
        return;
      }

      showStage(stage2);
      resetWater();

      startRainStrong();
      startTimer();
      startWaterRise();

      // ì§„ë‹¨ ì˜¤í”ˆ (í€´ì¦ˆ ë²„íŠ¼ ì—†ìŒ)
      setTimeout(()=>{
        retentionText.textContent = "ì•½ 32ë§Œ í†¤";
        diagnosis.classList.add("open");
      }, CONFIG.diagnoseAtSeconds*1000);
    }

    startBtn.addEventListener("click", startSimulation);
    retryBtn.addEventListener("click", startSimulation);

    // ===== (3) ì‹œìŠ¤í…œ ì§„ë‹¨ â†’ ë‹¤ìŒ í™”ë©´ìœ¼ë¡œ ë²„íŠ¼ìœ¼ë¡œ í€´ì¦ˆ ì˜¤í”ˆ =====
    closeDiagnosisBtn.addEventListener("click", ()=> diagnosis.classList.remove("open"));
    toQuizBtn.addEventListener("click", ()=>{
      diagnosis.classList.remove("open");
      openQuizAt(0);
    });

    // ===== (4) 2ë¬¸í•­ ìˆœì„œëŒ€ë¡œ(ëœë¤ ì—†ìŒ) =====
    // 1ë²ˆ ë¬¸ì œ: "ë„ì‹œì—ì„œ ë¹„ê°€ ì˜¤ë©´..." ì •ë‹µì€ 4ë²ˆ
    // 2ë²ˆ ë¬¸ì œ: "ê·¸ë¦°ì¸í”„ë¼ì—..." ì •ë‹µì€ 3ë²ˆ
    const QUIZZES = [
      {
        q: "ë„ì‹œì—ì„œ ë¹„ê°€ ì˜¤ë©´ ë¬¼ì´ ë¹¨ë¦¬ ë„˜ì¹˜ëŠ” ê°€ì¥ í° ì´ìœ ëŠ”?",
        options: [
          "í•˜ëŠ˜ì´ ë” ë‚®ì•„ì„œ",
          "ë¹„ê°€ í•­ìƒ ê°‘ìê¸° ì˜¤ê¸° ë•Œë¬¸ì—",
          "ë„ì‹œì—ëŠ” í˜¸ìˆ˜ê°€ ì—†ì–´ì„œ",
          "ì½˜í¬ë¦¬íŠ¸Â·ì•„ìŠ¤íŒ”íŠ¸ê°€ ë§ì•„ ë¬¼ì´ ìŠ¤ë©°ë“¤ í‹ˆì´ ì ì–´ì„œ"
        ],
        correctIndex: 3, // 0-based = 4ë²ˆ
        ok: "ì •ë‹µ! ë°”ë‹¥ì´ ë¬¼ì„ í¡ìˆ˜í•˜ì§€ ëª»í•˜ë©´ ë¹—ë¬¼ì´ í•œêº¼ë²ˆì— ëª°ë ¤ìš”.",
        bad: "ì˜¤ë‹µì…ë‹ˆë‹¤. í•µì‹¬ì€ â€˜ìŠ¤ë©°ë“¤ í‹ˆ(ì¹¨íˆ¬)â€™ì´ ë¶€ì¡±í•˜ë‹¤ëŠ” ì ì´ì—ìš”."
      },
      {
        q: "ê·¸ë¦°ì¸í”„ë¼ì— ê°€ì¥ ê°€ê¹Œìš´ ê²ƒì€?",
        options: [
          "ë¹—ë¬¼ì„ ë” ë¹¨ë¦¬ í•˜ìˆ˜ê´€ìœ¼ë¡œ ë³´ë‚´ëŠ” í° ê´€",
          "ë¹„ê°€ ì˜¤ë©´ ì¼œì§€ëŠ” ê²½ê³  ì‚¬ì´ë Œ",
          "ë¹—ë¬¼ì •ì›ì²˜ëŸ¼ ë¬¼ì„ ì ê¹ ëª¨ì•„ë‘ê³  ìŠ¤ë©°ë“¤ê²Œ í•˜ëŠ” ê³µê°„",
          "ì£¼ì°¨ì¥ì„ ë” ë‹¨ë‹¨í•˜ê²Œ í¬ì¥í•˜ê¸°"
        ],
        correctIndex: 2, // 0-based = 3ë²ˆ
        ok: "ì •ë‹µ! ê·¸ë¦°ì¸í”„ë¼ëŠ” â€˜ì €ë¥˜Â·ì¹¨íˆ¬â€™ë¡œ í•˜ìˆ˜ê´€ ë¶€ë‹´ì„ ì¤„ì—¬ìš”.",
        bad: "ì˜¤ë‹µì…ë‹ˆë‹¤. â€˜ë¬¼ ì €ì¥ + ìŠ¤ë©°ë“¤ê²Œ í•˜ê¸°â€™ê°€ í•µì‹¬ì´ì—ìš”."
      }
    ];

    let quizIndex = 0;
    let answeredCorrect = false;

    function openQuizAt(idx){
      quizIndex = idx;
      answeredCorrect = false;

      quizProgress.textContent = `${idx+1} / ${QUIZZES.length}`;
      quizFeedback.textContent = "";
      quizFeedback.className = "feedback";

      submitBtn.style.display = "block";
      nextBtn.style.display = "none";

      // ë Œë”
      const item = QUIZZES[idx];
      qTitle.textContent = item.q;
      optionsBox.innerHTML = "";

      item.options.forEach((txt, i)=>{
        const label = document.createElement("label");
        label.className = "opt";

        const input = document.createElement("input");
        input.type = "radio";
        input.name = "q";
        input.value = String(i);

        const span = document.createElement("span");
        // ë²ˆí˜¸ë¥¼ ëª…í™•íˆ ë³´ì—¬ì£¼ê¸°: 1) 2) 3) 4)
        span.textContent = `${i+1}) ${txt}`;

        label.appendChild(input);
        label.appendChild(span);
        optionsBox.appendChild(label);
      });

      quiz.classList.add("open");
    }

    closeQuizBtn.addEventListener("click", ()=> quiz.classList.remove("open"));

    quizForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      const picked = quizForm.querySelector('input[name="q"]:checked');
      if(!picked){
        quizFeedback.textContent = "ì •ë‹µì„ í•˜ë‚˜ ì„ íƒí•´ ì£¼ì„¸ìš”.";
        quizFeedback.className = "feedback bad";
        return;
      }

      const item = QUIZZES[quizIndex];
      const pickedIndex = Number(picked.value);
      const ok = pickedIndex === item.correctIndex;

      if(ok){
        answeredCorrect = true;
        quizFeedback.textContent = item.ok;
        quizFeedback.className = "feedback ok";

        // ë§ˆì§€ë§‰ ë¬¸ì œê°€ ì•„ë‹ˆë©´ "ë‹¤ìŒ ë¬¸ì œ"
        if(quizIndex < QUIZZES.length - 1){
          submitBtn.style.display = "none";
          nextBtn.style.display = "block";
        }else{
          // ë§ˆì§€ë§‰ ë¬¸ì œ ì •ë‹µì´ë©´ ë°”ë¡œ ë³´ìƒ
          setTimeout(()=>{
            quiz.classList.remove("open");
            reward.classList.add("open");
          }, 500);
        }
      }else{
        answeredCorrect = false;
        quizFeedback.textContent = item.bad;
        quizFeedback.className = "feedback bad";
      }
    });

    nextBtn.addEventListener("click", ()=>{
      if(!answeredCorrect) return;
      openQuizAt(quizIndex + 1);
    });

    // ===== ë³´ìƒ â†’ ì¢…ë£Œ =====
    rewardOkBtn.addEventListener("click", ()=>{
      reward.classList.remove("open");
      diagnosis.classList.remove("open");
      quiz.classList.remove("open");

      stopRain();
      stopTimer();
      stopCamera();
      resetWater();

      showStage(stageDone);
    });

    doneBtn.addEventListener("click", ()=>{
      alert("ë¯¸ì…˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ì°½(íƒ­)ì„ ë‹«ê³  ë‹¤ìŒ í™œë™ìœ¼ë¡œ ì´ë™í•´ ì£¼ì„¸ìš”.");
    });

    restartBtn.addEventListener("click", ()=>{
      reward.classList.remove("open");
      diagnosis.classList.remove("open");
      quiz.classList.remove("open");

      stopRain();
      stopTimer();
      stopCamera();
      resetWater();

      showStage(stage1);
    });
  </script>
</body>
</html>
