<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>ë³´ì´ì§€ ì•ŠëŠ” ë¬¼ì„ ë³´ë¼!</title>
  <style>
    :root{
      --bg:#0b1020; --panel:rgba(0,0,0,.65); --text:#f5f7ff;
      --red:#ff3b30; --blue:#2f7dff;
    }
    *{box-sizing:border-box}
    body{margin:0; overflow:hidden; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}

    .stage{position:fixed; inset:0; display:none; align-items:center; justify-content:center}
    .stage.active{display:flex}

    .panel{
      width:min(560px,92vw);
      padding:18px 16px;
      border-radius:16px;
      background:var(--panel);
      backdrop-filter: blur(8px);
      border:1px solid rgba(255,255,255,.12);
    }
    .warning{border:1px solid rgba(255,59,48,.35)}
    .warning-title{font-weight:900;letter-spacing:.08em;color:var(--red);font-size:18px}
    .warning-msg{font-size:20px;font-weight:900;margin-top:6px}
    .sub{opacity:.9;margin:10px 0 14px 0}

    .blink-dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--red);
      box-shadow:0 0 16px rgba(255,59,48,.9);
      animation:blink 1s infinite;
      margin-bottom:10px;
    }
    @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:.15}}

    .primary,.ghost{
      width:100%;
      border:0;
      border-radius:999px;
      padding:14px 16px;
      font-size:16px;
      margin-top:10px;
      cursor:pointer;
    }
    .primary{background:rgba(47,125,255,.95);color:#fff}
    .primary:disabled{opacity:.45; cursor:not-allowed}
    .ghost{background:rgba(255,255,255,.08);color:#fff}

    .footer-hint{
      position:fixed;bottom:14px;left:0;right:0;
      text-align:center;font-size:13px;opacity:.75;
      padding:0 12px;
    }

    #cam{
      position:fixed;inset:0;width:100%;height:100%;
      object-fit:cover;background:#000;
    }
    #rain{position:fixed;inset:0;width:100%;height:100%;pointer-events:none}

    #water{
      position:fixed;left:0;right:0;bottom:0;height:0%;
      background:linear-gradient(to top, rgba(47,125,255,.55), rgba(47,125,255,.15), rgba(47,125,255,0));
      backdrop-filter: blur(1px);
      pointer-events:none;
      transition:height 8s linear;
    }
    .water-text{
      position:absolute;left:16px;top:14px;
      font-weight:900;text-shadow:0 2px 10px rgba(0,0,0,.6);
    }

    .hud{
      position:fixed;top:12px;left:12px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px 12px;
      backdrop-filter: blur(8px);
    }
    .hud-title{font-weight:900}
    .hud-sub{opacity:.85;margin-top:2px}

    .modal{
      position:fixed;inset:0;
      display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
    }
    .modal.open{display:flex}

    .modal-card{
      width:min(620px,92vw);
      border-radius:18px;
      padding:16px 16px 14px;
      background:rgba(15,18,30,.92);
      border:1px solid rgba(255,255,255,.12);
    }
    .modal-title{font-size:18px;font-weight:950;margin:6px 0 10px}
    .modal-body{opacity:.95;line-height:1.55}
    .row{display:flex;gap:10px;margin:8px 0}
    .k{min-width:120px;opacity:.8}
    .v{flex:1}

    .shieldBig{font-size:44px; filter: drop-shadow(0 6px 18px rgba(47,125,255,.25));}
    .pill{
      display:inline-block;font-size:13px;opacity:.9;
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      margin:2px 0 10px;
    }

    .q-title{font-weight:900;margin-bottom:10px}
    .opt{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 12px; border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      margin:8px 0;
    }
    .opt input{margin-top:2px}
    .feedback{margin-top:10px; min-height:22px; font-weight:900;}
    .feedback.ok{color:#7CFF9A}
    .feedback.bad{color:#FF7C7C}

    .reward-card{text-align:center}
    .rewardShield{
      font-size:70px; margin:8px 0 6px;
      animation: pop 650ms ease-out both;
    }
    @keyframes pop{0%{transform:scale(.2);opacity:0}70%{transform:scale(1.18);opacity:1}100%{transform:scale(1);opacity:1}}
  </style>
</head>

<body>
  <section id="stage1" class="stage active">
    <div class="panel warning">
      <div class="blink-dot" aria-hidden="true"></div>
      <div class="warning-title">WARNING</div>
      <div class="warning-msg">ì§‘ì¤‘í˜¸ìš° ì‹œë®¬ë ˆì´ì…˜ ê°€ë™</div>
      <div id="geoStatus" class="sub">ì¤€ë¹„ ì¤‘â€¦</div>

      <button id="startBtn" class="primary" type="button">
        ìŠ¤ìºë„ˆ ì‹œì‘ (ì¹´ë©”ë¼/ìœ„ì¹˜ í—ˆìš©)
      </button>

      <button id="bypassBtn" class="ghost" type="button">
        ìœ„ì¹˜ í™•ì¸ì´ ì•ˆ ë˜ë©´(í”ŒëœB) ë°”ë¡œ ì‹œì‘
      </button>
    </div>
    <div class="footer-hint">ê¶Œí•œì„ í—ˆìš©í•˜ë©´ ì¹´ë©”ë¼ ìœ„ì— í­ìš°/ì¹¨ìˆ˜ ì‹œë®¬ë ˆì´ì…˜ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
  </section>

  <section id="stage2" class="stage">
    <video id="cam" playsinline muted autoplay></video>
    <canvas id="rain"></canvas>
    <div id="water"><div id="waterText" class="water-text">ìˆ˜ìœ„ ìƒìŠ¹â€¦</div></div>
    <div class="hud">
      <div class="hud-title">[ì‹œë®¬ë ˆì´ì…˜] ì‹œê°„ë‹¹ 100mm í­ìš°</div>
      <div id="timer" class="hud-sub">00:00</div>
    </div>
  </section>

  <div id="diagnosis" class="modal">
    <div class="modal-card">
      <div class="shieldBig">ğŸ›¡ï¸</div>
      <div class="modal-title">[ì‹œìŠ¤í…œ ì§„ë‹¨ ê²°ê³¼]</div>
      <div class="modal-body">
        <div class="row"><span class="k">ìƒí™©</span><span class="v">ì‹œê°„ë‹¹ 100mm ê¸°ë¡ì  í­ìš° ë°œìƒ!</span></div>
        <div class="row"><span class="k">ìš´ì •í˜¸ìˆ˜ ìƒíƒœ</span><span class="v">ë¹—ë¬¼ <b id="retentionText">ì•½ 30ë§Œ í†¤</b> ì €ë¥˜ ì„±ê³µ! (ìŠ¤í€ì§€ ëª¨ë“œ ì‘ë™ ì¤‘)</span></div>
        <div class="row"><span class="k">ê²°ê³¼</span><span class="v">ì£¼ë³€ ì¹¨ìˆ˜ ë°©ì–´ ì™„ë£Œ. <b>ì•ˆì „í•©ë‹ˆë‹¤.</b></span></div>
      </div>
      <button id="quizBtn" class="primary" type="button">í€´ì¦ˆí•˜ê¸° (ë³µë¶ˆë³µ 1ë¬¸í•­)</button>
      <button id="closeDiagnosisBtn" class="ghost" type="button">ë‹«ê¸°</button>
    </div>
  </div>

  <div id="quiz" class="modal">
    <div class="modal-card">
      <div class="modal-title">ê·¸ë¦°ì¸í”„ë¼ í€´ì¦ˆ</div>
      <div class="pill">ë¬¸í•­/ë³´ê¸°ëŠ” ëœë¤ì…ë‹ˆë‹¤.</div>

      <form id="quizForm">
        <div class="modal-body">
          <div id="qTitle" class="q-title">ë¬¸ì œ ë¡œë”© ì¤‘â€¦</div>
          <div id="options"></div>
          <div id="quizFeedback" class="feedback"></div>
        </div>
        <button class="primary" type="submit">ì œì¶œ</button>
        <button id="closeQuizBtn" class="ghost" type="button">ë‹«ê¸°</button>
      </form>
    </div>
  </div>

  <div id="reward" class="modal">
    <div class="modal-card reward-card">
      <div class="rewardShield">ğŸ›¡ï¸</div>
      <div class="modal-title">ë°©íŒ¨ íšë“!</div>
      <div id="rewardMsg" class="modal-body">ì˜í–ˆì–´ìš”.</div>
      <button id="rewardOkBtn" class="primary" type="button">í™•ì¸</button>
    </div>
  </div>

  <script>
    // === ì„¤ì • ===
    const CONFIG = { floodSeconds: 8, diagnoseAtSeconds: 9 };

    // === DOM ===
    const stage1 = document.getElementById("stage1");
    const stage2 = document.getElementById("stage2");
    const geoStatus = document.getElementById("geoStatus");
    const startBtn = document.getElementById("startBtn");
    const bypassBtn = document.getElementById("bypassBtn");

    const cam = document.getElementById("cam");
    const rainCanvas = document.getElementById("rain");
    const water = document.getElementById("water");
    const waterText = document.getElementById("waterText");
    const timerEl = document.getElementById("timer");

    const diagnosis = document.getElementById("diagnosis");
    const retentionText = document.getElementById("retentionText");
    const quizBtn = document.getElementById("quizBtn");
    const closeDiagnosisBtn = document.getElementById("closeDiagnosisBtn");

    const quiz = document.getElementById("quiz");
    const quizForm = document.getElementById("quizForm");
    const qTitle = document.getElementById("qTitle");
    const optionsBox = document.getElementById("options");
    const quizFeedback = document.getElementById("quizFeedback");
    const closeQuizBtn = document.getElementById("closeQuizBtn");

    const reward = document.getElementById("reward");
    const rewardMsg = document.getElementById("rewardMsg");
    const rewardOkBtn = document.getElementById("rewardOkBtn");

    // === ëœë¤ ë°ì´í„° ===
    const RETENTION_VARIANTS = ["ì•½ 30ë§Œ í†¤","ì•½ 28ë§Œ í†¤","ì•½ 32ë§Œ í†¤","ì•½ 25ë§Œ í†¤","ì•½ 35ë§Œ í†¤"];
    const WATER_TEXT_VARIANTS = ["ìˆ˜ìœ„ ìƒìŠ¹â€¦ ì‚°ì±…ë¡œ ì¹¨ìˆ˜ ìœ„í—˜!","ë°°ìˆ˜ í•œê³„ ì ‘ê·¼â€¦ í•˜ìˆ˜ê´€ì´ ë²„í‹°ëŠ” ì¤‘!","ìš°ìˆ˜ ìœ ì¶œ ê¸‰ì¦â€¦ ì£¼ë³€ ì €ì§€ëŒ€ ì£¼ì˜!"];
    const REWARD_MESSAGES = [
      "ì •ë‹µ! ê·¸ë¦°ì¸í”„ë¼ëŠ” ë¹—ë¬¼ì„ â€˜ì²œì²œíˆâ€™ ëª¨ìœ¼ê³  ìŠ¤ë©°ë“¤ê²Œ í•©ë‹ˆë‹¤.",
      "ì¢‹ì•„ìš”! â€˜ìŠ¤ë©°ë“¤ í‹ˆ(ì¹¨íˆ¬)â€™ì´ ë§ì„ìˆ˜ë¡ í™ìˆ˜ ìœ„í—˜ì´ ì¤„ì–´ìš”.",
      "ë©‹ì§‘ë‹ˆë‹¤. ë¹—ë¬¼ì •ì›Â·íˆ¬ìˆ˜ë¸”ë¡Â·ì‹ìƒìˆ˜ë¡œê°€ ì´ëŸ° ì—­í• ì„ í•©ë‹ˆë‹¤."
    ];
    const QUESTION_BANK = [
      {
        q: "ë„ì‹œì—ì„œ ë¹„ê°€ ì˜¤ë©´ ë¬¼ì´ ë¹¨ë¦¬ ë„˜ì¹˜ëŠ” ê°€ì¥ í° ì´ìœ ëŠ” ë¬´ì—‡ì¼ê¹Œìš”?",
        options: ["ë¹„ê°€ ë”ëŸ¬ì›Œì„œ","ì½˜í¬ë¦¬íŠ¸Â·ì•„ìŠ¤íŒ”íŠ¸ê°€ ë§ì•„ ë¬¼ì´ ìŠ¤ë©°ë“¤ í‹ˆì´ ì ì–´ì„œ","ë°”ëŒì´ ë§ì´ ë¶ˆì–´ì„œ","ë‚˜ë¬´ê°€ ë„ˆë¬´ ë§ì•„ì„œ"],
        correct: "ì½˜í¬ë¦¬íŠ¸Â·ì•„ìŠ¤íŒ”íŠ¸ê°€ ë§ì•„ ë¬¼ì´ ìŠ¤ë©°ë“¤ í‹ˆì´ ì ì–´ì„œ",
        ok: "ì •ë‹µ! ë•…ì´ ë¬¼ì„ í¡ìˆ˜í•˜ì§€ ëª»í•˜ë©´ ë¹—ë¬¼ì´ í•œêº¼ë²ˆì— ëª°ë ¤ìš”.",
        bad:"ì˜¤ë‹µì´ì—ìš”. í•µì‹¬ì€ â€˜ìŠ¤ë©°ë“¤ í‹ˆâ€™ì´ ë¶€ì¡±í•˜ë‹¤ëŠ” ì ì…ë‹ˆë‹¤."
      },
      {
        q: "ë‹¤ìŒ ì¤‘ â€˜ê·¸ë¦°ì¸í”„ë¼(ì €ì˜í–¥ê°œë°œ)â€™ì— ê°€ì¥ ê°€ê¹Œìš´ ê²ƒì€ ë¬´ì—‡ì¼ê¹Œìš”?",
        options: ["ë¹—ë¬¼ì„ ë°”ë¡œ í•˜ìˆ˜ê´€ìœ¼ë¡œ ë³´ë‚´ëŠ” í° ê´€","ë¹—ë¬¼ì •ì›ì²˜ëŸ¼ ë¬¼ì„ ì ê¹ ëª¨ì•„ë‘ê³  ìŠ¤ë©°ë“¤ê²Œ í•˜ëŠ” ê³µê°„","ë¹„ê°€ ì˜¤ë©´ ì¼œì§€ëŠ” ì‚¬ì´ë Œ","ì£¼ì°¨ì¥ì„ ë” ë‹¨ë‹¨í•˜ê²Œ í¬ì¥í•˜ê¸°"],
        correct: "ë¹—ë¬¼ì •ì›ì²˜ëŸ¼ ë¬¼ì„ ì ê¹ ëª¨ì•„ë‘ê³  ìŠ¤ë©°ë“¤ê²Œ í•˜ëŠ” ê³µê°„",
        ok:"ì •ë‹µ! ê·¸ë¦°ì¸í”„ë¼ëŠ” í˜„ì¥ì—ì„œ ì €ë¥˜Â·ì¹¨íˆ¬ë¡œ ë¶€ë‹´ì„ ì¤„ì—¬ìš”.",
        bad:"ì˜¤ë‹µì´ì—ìš”. ë¬¼ì„ ëª¨ì•„ë‘ê³  ìŠ¤ë©°ë“¤ê²Œ í•˜ëŠ” ê³µê°„ì´ í•µì‹¬ì…ë‹ˆë‹¤."
      },
      {
        q: "ê·¸ë¦°ì¸í”„ë¼ê°€ í™ìˆ˜ ìœ„í—˜ì„ ì¤„ì´ëŠ” ë°©ì‹ìœ¼ë¡œ ì•Œë§ì€ ê²ƒì€ ë¬´ì—‡ì¼ê¹Œìš”?",
        options: ["ë¬¼ì„ ë” ë¹¨ë¦¬ í˜ë ¤ë³´ë‚¸ë‹¤","ë¬¼ì„ ì²œì²œíˆ ëª¨ìœ¼ê³  ìŠ¤ë©°ë“¤ê²Œ í•˜ê³  ì €ì¥í•´ í•˜ìˆ˜ê´€ ë¶€ë‹´ì„ ì¤„ì¸ë‹¤","ë¹„ë¥¼ ë©ˆì¶”ê²Œ í•œë‹¤","ê°•ì„ ë¬´ì¡°ê±´ ë” ê¹Šê²Œ íŒë‹¤"],
        correct: "ë¬¼ì„ ì²œì²œíˆ ëª¨ìœ¼ê³  ìŠ¤ë©°ë“¤ê²Œ í•˜ê³  ì €ì¥í•´ í•˜ìˆ˜ê´€ ë¶€ë‹´ì„ ì¤„ì¸ë‹¤",
        ok:"ì •ë‹µ! â€˜ì²œì²œíˆ(ì§€ì—°)+ìŠ¤ë©°ë“¦(ì¹¨íˆ¬)+ì €ì¥(ì €ë¥˜)â€™ì´ í•µì‹¬ì´ì—ìš”.",
        bad:"ì˜¤ë‹µì´ì—ìš”. â€˜ì²œì²œíˆ ëª¨ìœ¼ê³  ìŠ¤ë©°ë“¤ê²Œâ€™ê°€ í•µì‹¬ì…ë‹ˆë‹¤."
      }
    ];

    const pickOne = (arr)=>arr[Math.floor(Math.random()*arr.length)];
    const shuffle = (arr)=>{
      const a=[...arr];
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    };

    // === 1ë‹¨ê³„ ì•ˆë‚´ ===
    geoStatus.textContent = "ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì§„í–‰í•˜ì„¸ìš”. (GPS ê²Œì´íŠ¸ëŠ” ìƒëµí–ˆìŠµë‹ˆë‹¤)";

    // === ì¹´ë©”ë¼/ì—°ì¶œ ===
    async function startCamera(){
      const stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"environment"}, audio:false });
      cam.srcObject = stream;
      await cam.play();
    }
    function showStage2(){
      stage1.classList.remove("active");
      stage2.classList.add("active");
    }
    function startTimer(){
      const t0=Date.now();
      const t=setInterval(()=>{
        const sec=Math.floor((Date.now()-t0)/1000);
        const mm=String(Math.floor(sec/60)).padStart(2,"0");
        const ss=String(sec%60).padStart(2,"0");
        timerEl.textContent=`${mm}:${ss}`;
      },250);
      setTimeout(()=>clearInterval(t),60000);
    }
    function startWaterRise(){
      waterText.textContent = pickOne(WATER_TEXT_VARIANTS);
      setTimeout(()=>{
        water.style.transition = `height ${CONFIG.floodSeconds}s linear`;
        water.style.height="55%";
      },400);
    }
    function openDiagnosis(){
      retentionText.textContent = pickOne(RETENTION_VARIANTS);
      diagnosis.classList.add("open");
    }

    // ë¹„(ìº”ë²„ìŠ¤)
    let rainRunning=false;
    function startRain(){
      const ctx = rainCanvas.getContext("2d");
      function resize(){
        const dpr=window.devicePixelRatio||1;
        rainCanvas.width=Math.floor(window.innerWidth*dpr);
        rainCanvas.height=Math.floor(window.innerHeight*dpr);
        rainCanvas.style.width=window.innerWidth+"px";
        rainCanvas.style.height=window.innerHeight+"px";
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      resize();
      window.addEventListener("resize", resize);

      const drops=[];
      const COUNT=220;
      for(let i=0;i<COUNT;i++){
        drops.push({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,len:8+Math.random()*16,spd:12+Math.random()*26,a:0.22+Math.random()*0.35});
      }
      rainRunning=true;
      (function loop(){
        if(!rainRunning) return;
        ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
        ctx.lineWidth=1.2;
        for(const d of drops){
          ctx.strokeStyle=`rgba(200,220,255,${d.a})`;
          ctx.beginPath(); ctx.moveTo(d.x,d.y); ctx.lineTo(d.x+1.2,d.y+d.len); ctx.stroke();
          d.y+=d.spd; d.x+=1.4;
          if(d.y>window.innerHeight){d.y=-d.len; d.x=Math.random()*window.innerWidth;}
          if(d.x>window.innerWidth) d.x=0;
        }
        requestAnimationFrame(loop);
      })();
    }

    async function startSimulation(){
      try{ await startCamera(); }
      catch(e){ alert("ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ë¥¼ í—ˆìš©í•´ ì£¼ì„¸ìš”."); return; }

      showStage2();
      startRain();
      startTimer();
      startWaterRise();
      setTimeout(openDiagnosis, CONFIG.diagnoseAtSeconds*1000);
    }

    startBtn.addEventListener("click", startSimulation);
    bypassBtn.addEventListener("click", startSimulation);

    // === í€´ì¦ˆ ===
    let currentQuestion=null;
    function renderQuestion(){
      currentQuestion = pickOne(QUESTION_BANK);
      const opts = shuffle(currentQuestion.options);
      qTitle.textContent = currentQuestion.q;
      optionsBox.innerHTML="";
      quizFeedback.textContent="";
      quizFeedback.className="feedback";

      opts.forEach((txt, idx)=>{
        const id=`opt_${idx}`;
        const label=document.createElement("label");
        label.className="opt";
        const input=document.createElement("input");
        input.type="radio"; input.name="q"; input.value=txt; input.id=id;
        const span=document.createElement("span");
        span.textContent=txt;
        label.appendChild(input); label.appendChild(span);
        optionsBox.appendChild(label);
      });
    }

    quizBtn.addEventListener("click", ()=>{
      diagnosis.classList.remove("open");
      renderQuestion();
      quiz.classList.add("open");
    });

    closeDiagnosisBtn.addEventListener("click", ()=> diagnosis.classList.remove("open"));
    closeQuizBtn.addEventListener("click", ()=> quiz.classList.remove("open"));

    quizForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      const picked = quizForm.querySelector('input[name="q"]:checked');
      if(!picked){
        quizFeedback.textContent="ì •ë‹µì„ í•˜ë‚˜ ì„ íƒí•´ ì£¼ì„¸ìš”.";
        quizFeedback.className="feedback bad";
        return;
      }
      const ok = picked.value === currentQuestion.correct;
      if(ok){
        quizFeedback.textContent=currentQuestion.ok;
        quizFeedback.className="feedback ok";
        setTimeout(()=>{
          quiz.classList.remove("open");
          rewardMsg.textContent = pickOne(REWARD_MESSAGES);
          reward.classList.add("open");
        },450);
      }else{
        quizFeedback.textContent=currentQuestion.bad;
        quizFeedback.className="feedback bad";
      }
    });

    rewardOkBtn.addEventListener("click", ()=> reward.classList.remove("open"));
  </script>
</body>
</html>
