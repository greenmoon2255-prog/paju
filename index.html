<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>ìš´ì •í˜¸ìˆ˜ í­ìš° AR ë¯¸ì…˜</title>
  <style>
    :root{
      --bg:#0b1020; --panel:rgba(0,0,0,.65); --text:#f5f7ff;
      --red:#ff3b30; --blue:#2f7dff; --ok:#7CFF9A; --bad:#FF7C7C;
    }
    *{box-sizing:border-box}
    body{margin:0; overflow:hidden; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}

    .stage{position:fixed; inset:0; display:none; align-items:center; justify-content:center}
    .stage.active{display:flex}

    .panel{
      width:min(640px,92vw);
      padding:18px 16px;
      border-radius:18px;
      background:var(--panel);
      backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,.12);
    }
    .warning{border:1px solid rgba(255,59,48,.35)}
    .blink-dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--red);
      box-shadow:0 0 18px rgba(255,59,48,.9);
      animation:blink 1s infinite;
      margin-bottom:10px;
    }
    @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:.15}}
    .warning-title{font-weight:950;letter-spacing:.08em;color:var(--red);font-size:18px}
    .warning-msg{font-size:20px;font-weight:950;margin-top:6px}
    .sub{opacity:.9;margin:10px 0 14px 0;line-height:1.45}

    button{
      width:100%;
      border:0;
      border-radius:999px;
      padding:14px 16px;
      font-size:16px;
      font-weight:900;
      margin-top:10px;
      cursor:pointer;
      touch-action:manipulation;
    }
    .primary{background:rgba(47,125,255,.95);color:#fff}
    .ghost{background:rgba(255,255,255,.10);color:#fff}

    .footer-hint{
      position:fixed; bottom:14px; left:0; right:0;
      text-align:center; font-size:13px; opacity:.75;
      padding:0 12px;
    }

    /* ì¹´ë©”ë¼ + ì˜¤ë²„ë ˆì´ */
    #cam{
      position:fixed; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      background:#000;
    }
    #rain{
      position:fixed; inset:0;
      width:100%; height:100%;
      pointer-events:none;
    }
    #water{
      position:fixed; left:0; right:0; bottom:0;
      height:0%;
      background:linear-gradient(to top, rgba(47,125,255,.62), rgba(47,125,255,.22), rgba(47,125,255,0));
      pointer-events:none;
      transition:height 7s linear;
    }
    .water-text{
      position:absolute; left:16px; top:14px;
      font-weight:950;
      text-shadow:0 2px 10px rgba(0,0,0,.55);
    }
    .hud{
      position:fixed; top:12px; left:12px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px 12px;
      backdrop-filter: blur(8px);
    }
    .hud-title{font-weight:950}
    .hud-sub{opacity:.85;margin-top:2px}

    /* ëª¨ë‹¬ */
    .modal{
      position:fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
    }
    .modal.open{display:flex}
    .modal-card{
      width:min(680px,92vw);
      border-radius:18px;
      padding:16px 16px 14px;
      background:rgba(15,18,30,.92);
      border:1px solid rgba(255,255,255,.12);
    }
    .modal-title{font-size:18px;font-weight:950;margin:6px 0 10px}
    .modal-body{opacity:.95;line-height:1.55}
    .row{display:flex;gap:10px;margin:8px 0}
    .k{min-width:120px;opacity:.8}
    .v{flex:1}

    .shieldBig{font-size:46px; filter:drop-shadow(0 6px 18px rgba(47,125,255,.25));}

    /* í€´ì¦ˆ */
    .pill{
      display:inline-block;font-size:13px;opacity:.9;
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      margin:2px 0 10px;
    }
    .q-title{font-weight:950;margin-bottom:10px}
    .opt{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 12px; border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      margin:8px 0;
    }
    .opt input{margin-top:2px}
    .feedback{margin-top:10px;min-height:22px;font-weight:950}
    .feedback.ok{color:var(--ok)}
    .feedback.bad{color:var(--bad)}

    /* ë³´ìƒ/ì™„ë£Œ */
    .reward-card{text-align:center}
    .rewardShield{font-size:74px;margin:8px 0 6px;animation:pop 650ms ease-out both}
    @keyframes pop{0%{transform:scale(.2);opacity:0}70%{transform:scale(1.18);opacity:1}100%{transform:scale(1);opacity:1}}

    /* ì˜¤ë¥˜ ì•ˆë‚´ ë°” */
    #errorBar{
      position:fixed; left:10px; right:10px; bottom:10px;
      display:none;
      background:rgba(255,59,48,.20);
      border:1px solid rgba(255,59,48,.45);
      border-radius:14px;
      padding:12px 12px;
      line-height:1.45;
      backdrop-filter: blur(8px);
    }
    #errorBar.show{display:block}
    #errorTitle{font-weight:950}
    #errorMsg{opacity:.95;margin-top:4px}
  </style>
</head>

<body>
  <!-- 1ë‹¨ê³„ -->
  <section id="stage1" class="stage active">
    <div class="panel warning">
      <div class="blink-dot"></div>
      <div class="warning-title">WARNING</div>
      <div class="warning-msg">ì§‘ì¤‘í˜¸ìš° ì‹œë®¬ë ˆì´ì…˜ ê°€ë™</div>
      <div class="sub">
        ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¹´ë©”ë¼ í™”ë©´ ìœ„ì— <b>í›¨ì”¬ ê°•í•œ í­ìš°</b>ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.<br/>
        ê²€ì€ í™”ë©´ì´ ë‚˜ì˜¤ë©´, ëŒ€ë¶€ë¶„ â€œì¸ì•± ë¸Œë¼ìš°ì €â€ ë˜ëŠ” â€œì¹´ë©”ë¼ ê¶Œí•œâ€ ë¬¸ì œì…ë‹ˆë‹¤.
      </div>

      <button id="startBtn" class="primary" type="button">ìŠ¤ìºë„ˆ ì‹œì‘ (ì¹´ë©”ë¼ í—ˆìš©)</button>
      <button id="retryBtn" class="ghost" type="button">ë¬¸ì œê°€ ìˆìœ¼ë©´ ë‹¤ì‹œ ì‹œë„</button>
    </div>

    <div class="footer-hint">ê°€ëŠ¥í•˜ë©´ Safari/Chromeì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”. (ì¹´ì¹´ì˜¤/ë„¤ì´ë²„ ì¸ì•± ë¸Œë¼ìš°ì €ëŠ” ì‹¤íŒ¨ìœ¨ì´ ë†’ìŠµë‹ˆë‹¤)</div>
  </section>

  <!-- 2ë‹¨ê³„ -->
  <section id="stage2" class="stage">
    <video id="cam" playsinline muted autoplay></video>
    <canvas id="rain"></canvas>
    <div id="water"><div id="waterText" class="water-text">ìˆ˜ìœ„ ìƒìŠ¹â€¦ ì‚°ì±…ë¡œ ì¹¨ìˆ˜ ìœ„í—˜!</div></div>

    <div class="hud">
      <div class="hud-title">[ì‹œë®¬ë ˆì´ì…˜] ì‹œê°„ë‹¹ 100mm í­ìš°</div>
      <div id="timer" class="hud-sub">00:00</div>
    </div>
  </section>

  <!-- ì§„ë‹¨ -->
  <div id="diagnosis" class="modal">
    <div class="modal-card">
      <div class="shieldBig">ğŸ›¡ï¸</div>
      <div class="modal-title">[ì‹œìŠ¤í…œ ì§„ë‹¨ ê²°ê³¼]</div>
      <div class="modal-body">
        <div class="row"><span class="k">ìƒí™©</span><span class="v">ì‹œê°„ë‹¹ 100mm ê¸°ë¡ì  í­ìš° ë°œìƒ!</span></div>
        <div class="row"><span class="k">ìš´ì •í˜¸ìˆ˜ ìƒíƒœ</span><span class="v">ë¹—ë¬¼ <b id="retentionText">ì•½ 32ë§Œ í†¤</b> ì €ë¥˜ ì„±ê³µ! (ìŠ¤í€ì§€ ëª¨ë“œ ì‘ë™ ì¤‘)</span></div>
        <div class="row"><span class="k">ê²°ê³¼</span><span class="v">ì£¼ë³€ ì¹¨ìˆ˜ ë°©ì–´ ì™„ë£Œ. <b>ì•ˆì „í•©ë‹ˆë‹¤.</b></span></div>
      </div>
      <button id="quizBtn" class="primary" type="button">í€´ì¦ˆí•˜ê¸° (ë³µë¶ˆë³µ 1ë¬¸í•­)</button>
      <button id="closeDiagnosisBtn" class="ghost" type="button">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- í€´ì¦ˆ -->
  <div id="quiz" class="modal">
    <div class="modal-card">
      <div class="modal-title">ê·¸ë¦°ì¸í”„ë¼ í€´ì¦ˆ</div>
      <div class="pill">ë¬¸í•­/ë³´ê¸°ëŠ” ëœë¤ì…ë‹ˆë‹¤.</div>

      <form id="quizForm">
        <div class="modal-body">
          <div id="qTitle" class="q-title">ë¬¸ì œ ë¡œë”© ì¤‘â€¦</div>
          <div id="options"></div>
          <div id="quizFeedback" class="feedback"></div>
        </div>

        <button class="primary" type="submit">ì œì¶œ</button>
        <button id="closeQuizBtn" class="ghost" type="button">ë‹«ê¸°</button>
      </form>
    </div>
  </div>

  <!-- ë³´ìƒ -->
  <div id="reward" class="modal">
    <div class="modal-card reward-card">
      <div class="rewardShield">ğŸ›¡ï¸</div>
      <div class="modal-title">ë°©íŒ¨ íšë“!</div>
      <div id="rewardMsg" class="modal-body">ì •ë‹µ! ê·¸ë¦°ì¸í”„ë¼ëŠ” ë¹—ë¬¼ì„ ì²œì²œíˆ ëª¨ìœ¼ê³  ìŠ¤ë©°ë“¤ê²Œ í•©ë‹ˆë‹¤.</div>
      <button id="rewardOkBtn" class="primary" type="button">ì™„ë£Œ</button>
    </div>
  </div>

  <!-- ì™„ë£Œ -->
  <section id="stageDone" class="stage">
    <div class="panel">
      <div style="font-weight:950;font-size:20px;">ë¯¸ì…˜ ì™„ë£Œ âœ…</div>
      <div style="opacity:.9;margin-top:8px;line-height:1.55;">
        ë°©íŒ¨ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.<br/>ì´ ì°½(íƒ­)ì„ ë‹«ê³  ë‹¤ìŒ í™œë™ìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”.
      </div>
      <button id="doneBtn" class="primary" type="button">ì¢…ë£Œ ì•ˆë‚´</button>
      <button id="restartBtn" class="ghost" type="button">(êµì‚¬ìš©) ë‹¤ì‹œ ì‹œì‘</button>
    </div>
    <div class="footer-hint">ì›¹í˜ì´ì§€ëŠ” ë³´ì•ˆ ì •ì±…ìƒ ë²„íŠ¼ìœ¼ë¡œ íƒ­ì„ ê°•ì œ ì¢…ë£Œí•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤.</div>
  </section>

  <!-- ì˜¤ë¥˜ ë°” -->
  <div id="errorBar" role="status" aria-live="polite">
    <div id="errorTitle">ì‹¤í–‰ì´ ë§‰í˜”ìŠµë‹ˆë‹¤</div>
    <div id="errorMsg"></div>
  </div>

  <script>
    // ===== ì„¤ì • =====
    const CONFIG = { floodSeconds: 7, diagnoseAtSeconds: 9 };

    // ===== DOM =====
    const stage1 = document.getElementById("stage1");
    const stage2 = document.getElementById("stage2");
    const stageDone = document.getElementById("stageDone");

    const startBtn = document.getElementById("startBtn");
    const retryBtn = document.getElementById("retryBtn");

    const cam = document.getElementById("cam");
    const rainCanvas = document.getElementById("rain");
    const water = document.getElementById("water");
    const timerEl = document.getElementById("timer");

    const diagnosis = document.getElementById("diagnosis");
    const retentionText = document.getElementById("retentionText");
    const quizBtn = document.getElementById("quizBtn");
    const closeDiagnosisBtn = document.getElementById("closeDiagnosisBtn");

    const quiz = document.getElementById("quiz");
    const quizForm = document.getElementById("quizForm");
    const qTitle = document.getElementById("qTitle");
    const optionsBox = document.getElementById("options");
    const quizFeedback = document.getElementById("quizFeedback");
    const closeQuizBtn = document.getElementById("closeQuizBtn");

    const reward = document.getElementById("reward");
    const rewardMsg = document.getElementById("rewardMsg");
    const rewardOkBtn = document.getElementById("rewardOkBtn");

    const doneBtn = document.getElementById("doneBtn");
    const restartBtn = document.getElementById("restartBtn");

    const errorBar = document.getElementById("errorBar");
    const errorMsg = document.getElementById("errorMsg");

    // ===== ëœë¤ =====
    const pickOne = (arr)=>arr[Math.floor(Math.random()*arr.length)];
    const shuffle = (arr)=>{
      const a=[...arr];
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    };

    const RETENTION_VARIANTS = ["ì•½ 35ë§Œ í†¤","ì•½ 32ë§Œ í†¤","ì•½ 30ë§Œ í†¤","ì•½ 28ë§Œ í†¤"];
    const REWARD_MESSAGES = [
      "ì •ë‹µ! ê·¸ë¦°ì¸í”„ë¼ëŠ” ë¹—ë¬¼ì„ â€˜ì²œì²œíˆâ€™ ëª¨ìœ¼ê³  ìŠ¤ë©°ë“¤ê²Œ í•©ë‹ˆë‹¤.",
      "ì¢‹ì•„ìš”. â€˜ì €ë¥˜Â·ì¹¨íˆ¬Â·ì§€ì—°â€™ì´ í™ìˆ˜ ìœ„í—˜ì„ ì¤„ì…ë‹ˆë‹¤.",
      "ë©‹ì§‘ë‹ˆë‹¤. ë¹—ë¬¼ì •ì›Â·íˆ¬ìˆ˜ë¸”ë¡Â·ì‹ìƒìˆ˜ë¡œê°€ ì´ëŸ° ì—­í• ì„ í•©ë‹ˆë‹¤."
    ];
    const QUESTION_BANK = [
      {
        q: "ë„ì‹œì—ì„œ ë¹„ê°€ ì˜¤ë©´ ë¬¼ì´ ë¹¨ë¦¬ ë„˜ì¹˜ëŠ” ê°€ì¥ í° ì´ìœ ëŠ”?",
        options: ["ë¹„ê°€ ë”ëŸ¬ì›Œì„œ","ì½˜í¬ë¦¬íŠ¸Â·ì•„ìŠ¤íŒ”íŠ¸ê°€ ë§ì•„ ìŠ¤ë©°ë“¤ í‹ˆì´ ì ì–´ì„œ","ë°”ëŒì´ ë§ì´ ë¶ˆì–´ì„œ","ë‚˜ë¬´ê°€ ë„ˆë¬´ ë§ì•„ì„œ"],
        correct:"ì½˜í¬ë¦¬íŠ¸Â·ì•„ìŠ¤íŒ”íŠ¸ê°€ ë§ì•„ ìŠ¤ë©°ë“¤ í‹ˆì´ ì ì–´ì„œ",
        ok:"ì •ë‹µ! ìŠ¤ë©°ë“¤ í‹ˆì´ ì—†ìœ¼ë©´ ë¹—ë¬¼ì´ í•œêº¼ë²ˆì— ëª°ë ¤ìš”.",
        bad:"ì˜¤ë‹µì´ì—ìš”. í•µì‹¬ì€ â€˜ìŠ¤ë©°ë“¤ í‹ˆ(ì¹¨íˆ¬)â€™ì…ë‹ˆë‹¤."
      },
      {
        q: "ê·¸ë¦°ì¸í”„ë¼ì— ê°€ì¥ ê°€ê¹Œìš´ ê²ƒì€?",
        options:["ë¹—ë¬¼ì„ ë°”ë¡œ í•˜ìˆ˜ê´€ìœ¼ë¡œ ë³´ë‚´ëŠ” í° ê´€","ë¹—ë¬¼ì •ì›ì²˜ëŸ¼ ë¬¼ì„ ëª¨ì•„ ìŠ¤ë©°ë“¤ê²Œ í•˜ëŠ” ê³µê°„","ë¹„ê°€ ì˜¤ë©´ ì¼œì§€ëŠ” ì‚¬ì´ë Œ","ì£¼ì°¨ì¥ì„ ë” ë‹¨ë‹¨í•˜ê²Œ í¬ì¥í•˜ê¸°"],
        correct:"ë¹—ë¬¼ì •ì›ì²˜ëŸ¼ ë¬¼ì„ ëª¨ì•„ ìŠ¤ë©°ë“¤ê²Œ í•˜ëŠ” ê³µê°„",
        ok:"ì •ë‹µ! í˜„ì¥ì—ì„œ ì €ë¥˜Â·ì¹¨íˆ¬ë¡œ ë¶€ë‹´ì„ ì¤„ì…ë‹ˆë‹¤.",
        bad:"ì˜¤ë‹µì´ì—ìš”. ë¬¼ì„ ëª¨ì•„ë‘ê³  ìŠ¤ë©°ë“¤ê²Œ í•˜ëŠ” ê²Œ í•µì‹¬ì…ë‹ˆë‹¤."
      }
    ];

    // ===== ìœ í‹¸ =====
    function showStage(el){
      stage1.classList.remove("active");
      stage2.classList.remove("active");
      stageDone.classList.remove("active");
      el.classList.add("active");
    }
    function showError(text){
      errorMsg.textContent = text;
      errorBar.classList.add("show");
      // 6ì´ˆ ë’¤ ìë™ ìˆ¨ê¹€(ë„ˆë¬´ ê±°ìŠ¬ë¦¬ì§€ ì•Šê²Œ)
      setTimeout(()=>errorBar.classList.remove("show"), 6000);
    }

    // ===== ì¹´ë©”ë¼ =====
    async function startCamera(){
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        throw new Error("ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
      const stream = await navigator.mediaDevices.getUserMedia({
        video:{facingMode:"environment"},
        audio:false
      });
      cam.srcObject = stream;
      await cam.play();
    }
    function stopCamera(){
      try{
        const s = cam.srcObject;
        if(s && s.getTracks) s.getTracks().forEach(t=>t.stop());
        cam.srcObject = null;
      }catch(e){}
    }

    // ===== íƒ€ì´ë¨¸ =====
    let timerHandle=null;
    function startTimer(){
      const t0=Date.now();
      timerEl.textContent="00:00";
      timerHandle=setInterval(()=>{
        const sec=Math.floor((Date.now()-t0)/1000);
        const mm=String(Math.floor(sec/60)).padStart(2,"0");
        const ss=String(sec%60).padStart(2,"0");
        timerEl.textContent=`${mm}:${ss}`;
      },250);
    }
    function stopTimer(){
      if(timerHandle) clearInterval(timerHandle);
      timerHandle=null;
    }

    // ===== ë¬¼ =====
    function startWaterRise(){
      water.style.transition=`height ${CONFIG.floodSeconds}s linear`;
      water.style.height="55%";
    }
    function resetWater(){
      water.style.transition="none";
      water.style.height="0%";
    }

    // ===== í­ìš°(ê°•í™” ë²„ì „) =====
    let rainRunning=false;
    let rafId=null;
    function startRainStrong(){
      const ctx = rainCanvas.getContext("2d");

      function resize(){
        const dpr = window.devicePixelRatio || 1;
        rainCanvas.width = Math.floor(innerWidth*dpr);
        rainCanvas.height = Math.floor(innerHeight*dpr);
        rainCanvas.style.width = innerWidth+"px";
        rainCanvas.style.height = innerHeight+"px";
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      resize();
      window.addEventListener("resize", resize);

      // âœ… í›¨ì”¬ ê°•í•œ ë¹„: ë°€ë„â†‘, ë‘ê»˜â†‘, ê¸¸ì´â†‘, ë°ê¸°â†‘
      const drops=[];
      const COUNT = 700;
      for(let i=0;i<COUNT;i++){
        drops.push({
          x: Math.random()*innerWidth,
          y: Math.random()*innerHeight,
          len: 18 + Math.random()*55,
          spd: 28 + Math.random()*55,
          a: 0.55 + Math.random()*0.40,
          w: 1.6 + Math.random()*1.6
        });
      }

      rainRunning=true;
      const loop=()=>{
        if(!rainRunning) return;
        ctx.clearRect(0,0,innerWidth,innerHeight);

        // ë²ˆê°œ ê°™ì€ "í­ìš° ì»¤íŠ¼" ëŠë‚Œ ì‚´ì§ ì¶”ê°€
        ctx.fillStyle = "rgba(210,230,255,0.05)";
        ctx.fillRect(0,0,innerWidth,innerHeight);

        for(const d of drops){
          ctx.lineWidth = d.w;
          ctx.strokeStyle = `rgba(245,250,255,${d.a})`;
          ctx.beginPath();
          ctx.moveTo(d.x, d.y);
          ctx.lineTo(d.x + 2.2, d.y + d.len);
          ctx.stroke();

          d.y += d.spd;
          d.x += 3.6;
          if(d.y > innerHeight){ d.y = -d.len; d.x = Math.random()*innerWidth; }
          if(d.x > innerWidth) d.x = 0;
        }
        rafId = requestAnimationFrame(loop);
      };
      loop();
    }
    function stopRain(){
      rainRunning=false;
      if(rafId) cancelAnimationFrame(rafId);
      rafId=null;
      const ctx=rainCanvas.getContext("2d");
      ctx.clearRect(0,0,innerWidth,innerHeight);
    }

    // ===== ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ =====
    async function startSimulation(){
      errorBar.classList.remove("show");
      try{
        await startCamera();
      }catch(e){
        showError(
          "ì¹´ë©”ë¼ê°€ ì—´ë¦¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. " +
          "Safari/Chromeì—ì„œ ì—´ê³  ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”. " +
          "(ì¸ì•± ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì¢…ì¢… ë§‰í™ë‹ˆë‹¤)\n\n" +
          "ì˜¤ë¥˜: " + (e.message || e)
        );
        return;
      }

      showStage(stage2);
      resetWater();
      startRainStrong();
      startTimer();
      startWaterRise();

      setTimeout(()=>{
        retentionText.textContent = pickOne(RETENTION_VARIANTS);
        diagnosis.classList.add("open");
      }, CONFIG.diagnoseAtSeconds*1000);
    }

    startBtn.addEventListener("click", startSimulation);
    retryBtn.addEventListener("click", startSimulation);

    // ===== ì§„ë‹¨/í€´ì¦ˆ =====
    closeDiagnosisBtn.addEventListener("click", ()=> diagnosis.classList.remove("open"));

    let currentQuestion=null;
    function renderQuestion(){
      currentQuestion = pickOne(QUESTION_BANK);
      const opts = shuffle(currentQuestion.options);
      qTitle.textContent = currentQuestion.q;
      optionsBox.innerHTML="";
      quizFeedback.textContent="";
      quizFeedback.className="feedback";

      opts.forEach((txt, idx)=>{
        const label=document.createElement("label");
        label.className="opt";
        const input=document.createElement("input");
        input.type="radio"; input.name="q"; input.value=txt;
        const span=document.createElement("span");
        span.textContent=txt;
        label.appendChild(input); label.appendChild(span);
        optionsBox.appendChild(label);
      });
    }

    quizBtn.addEventListener("click", ()=>{
      diagnosis.classList.remove("open");
      renderQuestion();
      quiz.classList.add("open");
    });

    closeQuizBtn.addEventListener("click", ()=> quiz.classList.remove("open"));

    quizForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      const picked = quizForm.querySelector('input[name="q"]:checked');
      if(!picked){
        quizFeedback.textContent="ì •ë‹µì„ í•˜ë‚˜ ì„ íƒí•´ ì£¼ì„¸ìš”.";
        quizFeedback.className="feedback bad";
        return;
      }
      const ok = picked.value === currentQuestion.correct;
      if(ok){
        quizFeedback.textContent=currentQuestion.ok;
        quizFeedback.className="feedback ok";
        setTimeout(()=>{
          quiz.classList.remove("open");
          rewardMsg.textContent = pickOne(REWARD_MESSAGES);
          reward.classList.add("open");
        },450);
      }else{
        quizFeedback.textContent=currentQuestion.bad;
        quizFeedback.className="feedback bad";
      }
    });

    // ===== ë³´ìƒ â†’ ì¢…ë£Œ =====
    rewardOkBtn.addEventListener("click", ()=>{
      reward.classList.remove("open");
      diagnosis.classList.remove("open");
      quiz.classList.remove("open");
      stopRain();
      stopTimer();
      stopCamera();
      resetWater();
      showStage(stageDone);
    });

    doneBtn.addEventListener("click", ()=>{
      alert("ë¯¸ì…˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ì°½(íƒ­)ì„ ë‹«ê³  ë‹¤ìŒ í™œë™ìœ¼ë¡œ ì´ë™í•´ ì£¼ì„¸ìš”.");
    });

    restartBtn.addEventListener("click", ()=>{
      reward.classList.remove("open");
      diagnosis.classList.remove("open");
      quiz.classList.remove("open");
      stopRain();
      stopTimer();
      stopCamera();
      resetWater();
      showStage(stage1);
    });
  </script>
</body>
</html>
